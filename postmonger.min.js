/*
 * Postmonger.js   version 0.0.9
 * https://github.com/kevinparkerson/postmonger
 *
 * Copyright (c) 2012 Kevin Parkerson
 * Available via the MIT or new BSD license.
 * Further details and documentation:
 * http://kevinparkerson.github.com/postmonger/
 *
 *///
(function(e,t){typeof define=="function"&&define.amd?define([],t):e.Postmonger=t(e)})(this,function(e){var t,n=e.Postmonger,r=e.addEventListener?e:window,i,s,o;return typeof exports!="undefined"?t=exports:t={},t.noConflict=function(){return e.Postmonger=n,this},t.version="0.0.9",i=t.Connection=function(e){e=e===Object(e)?e:{};var t=e.connect||r.parent,n=e.from||"*",i=e.to||"*",s=this;return typeof t=="string"&&(t=document.getElementById(t)),t&&!t.postMessage&&t.jquery&&(t=t.get(0)),t&&!t.postMessage&&(t.contentWindow||t.contentDocument)&&(t=t.contentWindow||t.contentDocument),!t||!t.postMessage?(r.console&&r.console.warn&&r.console.warn(" Warning: Postmonger could not establish connection with ",e.connect),!1):(s.connect=t,s.to=i,s.from=n,s)},s=t.Events=function(){var e=/\s+/,t=this;return t._callbacks={},t._has=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t._keys=function(e){if(Object.keys)return Object.keys(e);if(e!==Object(e))throw new TypeError("Invalid object");var n=[];for(var r in e)t._has(e,r)&&(n[n.length]=r);return n},t.on=function(n,r,i){var s,o,u,a,f;if(!r)return t;n=n.split(e),t._callbacks=t._callbacks||{},s=t._callbacks;while(o=n.shift())f=s[o],u=f?f.tail:{},a={},u.next=a,u.context=i,u.callback=r,s[o]={tail:a,next:f?f.next:u};return t},t.off=function(n,r,i){var s=t._callbacks,o,u,a,f,l;if(!s)return;if(!(n||r||i))return delete t._callbacks,t;n=n?n.split(e):t._keys(s);while(o=n.shift()){u=s[o],delete s[o];if(!u||!r&&!i)continue;a=u.tail;while((u=u.next)!==a)f=u.callback,l=u.context,((r&&f)!==r||(i&&l)!==i)&&t.on(o,f,l)}return t},t.trigger=function(n){var r,i,s,o,u,a,f;if(!(s=t._callbacks))return t;a=s.all,n=n.split(e),f=Array.prototype.slice.call(arguments,1);while(r=n.shift()){if(i=s[r]){o=i.tail;while((i=i.next)!==o)i.callback.apply(i.context||t,f)}if(i=a){o=i.tail,u=[r].concat(f);while((i=i.next)!==o)i.callback.apply(i.context||t,u)}}return t},t},o=t.Session=function(){var t=r.addEventListener||r.attachEvent,n=arguments.length>0?Array.prototype.slice.call(arguments,0):[{}],o={},u={},a=new s,f=new s,l=r.removeEventListener||r.detachEvent,c=this,h,p,d,v,m;c.on=a.on,c.off=a.off,c.trigger=f.trigger,c.end=function(){return a.off(),f.off(),l("message",m,!1),c};for(p=0,d=n.length;p<d;p++){h=new i(n[p]);if(h){v="f: "+h.from+"  t: "+h.to;if(!o[v]||o[v].connect!==h.connect)o[v]=h,u[h.from]=!0}}return t?(m=function(t){var n=[],r,i;try{r=JSON.parse(t.data)}catch(s){return!1}if(!u["*"]&&!u[t.origin])return!1;if(!r.e)return!1;n.push(r.e),delete r.e;for(i in r)n.push(r[i]);a.trigger.apply(e,n)},r.addEventListener("message",m,!1),f.on("all",function(){var e=Array.prototype.slice.call(arguments,0),t={},n;t.e=e.shift();for(p=0,d=e.length;p<d;p++)t["z"+(p+1)]=e[p];for(n in o)o[n].connect.postMessage(JSON.stringify(t),o[n].to)}),c):(r.console&&r.console.warn&&r.console.warn(" Warning: Postmonger could not listen for messages on this window."),!1)},t});